<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>班表系統 Pro</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0f0f14;
      --surface: #16161e;
      --surface2: #1c1c26;
      --border: #252535;
      --accent: #f5c842;
      --red: #e05c5c;
      --green: #5cbf8a;
      --blue: #5c9ee0;
      --purple: #a07adb;
      --text: #e8e8f0;
      --text-muted: #7a7a9a;
      --text-dim: #4a4a6a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Noto Sans TC', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* 頂部導航 */
    .header {
      background: rgba(22, 22, 30, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 14px 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .month-label {
      font-family: 'DM Mono', monospace;
      font-size: 22px;
      font-weight: 500;
      color: var(--accent);
    }

    .sub-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 8px;
    }

    .refresh-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 12px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .refresh-btn:active {
      transform: scale(0.95);
      opacity: 0.7;
    }

    /* 月份切換 */
    .month-tabs {
      display: flex;
      gap: 0;
      overflow-x: auto;
      scrollbar-width: none;
      margin: 0 -16px;
      padding: 0 16px;
    }

    .month-tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      flex-shrink: 0;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      font-family: 'DM Mono', monospace;
      transition: all .2s;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* 內容容器 */
    .content {
      padding: 12px 0 80px;
      transition: opacity 0.3s;
    }

    .group {
      margin: 0 12px 18px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--surface);
      animation: fadeUp 0.4s ease both;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .group-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
    }

    .gbadge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 99px;
      font-family: 'DM Mono', monospace;
    }

    .bt {
      background: rgba(92, 158, 224, .15);
      color: var(--blue);
      border: 1px solid rgba(92, 158, 224, 0.3);
    }

    .btc {
      background: rgba(160, 122, 219, .15);
      color: var(--purple);
      border: 1px solid rgba(160, 122, 219, 0.3);
    }

    .gname {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 300;
      text-align: right;
    }

    .ecard {
      border-bottom: 1px solid var(--border);
      padding: 12px 14px;
    }

    .ecard:last-child {
      border-bottom: none;
    }

    .einfo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .ename {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
    }

    .ehours {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
      font-family: 'DM Mono', monospace;
      letter-spacing: 0.5px;
    }

    .offc {
      font-size: 11px;
      color: var(--text-dim);
      text-align: right;
    }

    .offc b {
      color: var(--red);
      font-size: 13px;
      font-weight: 500;
    }

    /* 轉圈圈 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 日曆網格 */
    .cal {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 4px;
    }

    .cwd {
      text-align: center;
      font-size: 9px;
      color: var(--text-dim);
      padding: 2px 0 6px;
      font-family: 'DM Mono', monospace;
    }

    /* 只有帶日期的才有底色，空白格 (.empty) 為透明 */
    .cd {
      border-radius: 8px;
      padding: 5px 2px;
      min-height: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.2s;
    }

    .cd.has-date {
      background: rgba(255, 255, 255, .02);
    }

    .cd.empty {
      background: transparent;
    }

    /* 點選與今天標示 */
    .cd.selected {
      background: rgba(245, 200, 66, 0.1);
      box-shadow: inset 0 0 0 1px rgba(245, 200, 66, 0.3);
    }

    .cd.today {
      box-shadow: inset 0 0 0 1.5px var(--accent);
    }

    .dn {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      line-height: 1;
      margin-bottom: 4px;
    }

    .cd.today .dn {
      color: var(--accent);
      font-weight: 700;
    }

    .cd.selected .dn {
      color: var(--accent);
    }

    /* 班表文字狀態 */
    .sb {
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      line-height: 1.3;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }

    .time-tag {
      color: var(--green);
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .memo-tag {
      color: var(--text-muted);
      font-size: 8px;
      letter-spacing: 0.5px;
    }

    .dot {
      color: transparent;
      font-size: 10px;
    }

    .upd-footer {
      text-align: center;
      font-size: 10px;
      color: var(--text-dim);
      padding: 20px;
      font-family: 'DM Mono', monospace;
    }
  </style>
</head>

<body>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-size: 14px;">讀取班表…</div>
  </div>

  <div class="header">
    <div class="header-top">
      <div>
        <span class="month-label" id="mLabel">讀取中</span>
        <span class="sub-label" id="mSub">班表</span>
      </div>
      <button class="refresh-btn" onclick="refreshCurrent()">↻ 更新</button>
    </div>
    <div class="month-tabs" id="monthTabs"></div>
  </div>

  <div class="content" id="content"></div>
  <div class="upd-footer" id="updFooter"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxD2igshVAwOHOBhBGkdDRsk1FAvSKOMKzK56XD14avXTaiy6DqGo_cjI1vu_R0Qn_X/exec';

    const GROUPS = {
      taichung: { label: '台中', cls: 'btc', names: ['羿安', '怡君', '舒喬', 'Nana', 'Ines'] },
      taipei: { label: '台北', cls: 'bt', names: ['Yuki', 'Maru', '恒怡', '涵涵'] }
    };

    const PART_TIME = ['羿安', '怡君'];
    const WD = ['一', '二', '三', '四', '五', '六', '日'];

    let currentGid = null;
    let allSheets = [];
    let currentData = null;
    let selectedDay = null;

    function init() {
      const cachedSheets = localStorage.getItem('roster_sheets');
      if (cachedSheets) {
        allSheets = JSON.parse(cachedSheets);
        buildTabs();
      }
      fetchSheets();
    }

    function fetchSheets() {
      jsonp({}, (result) => {
        if (result.sheets) {
          allSheets = result.sheets;
          localStorage.setItem('roster_sheets', JSON.stringify(allSheets));
          buildTabs();
        }
      }, (err) => console.error("Sheets update failed", err));
    }

    function buildTabs() {
      const container = document.getElementById('monthTabs');
      const activeGid = currentGid;
      container.innerHTML = '';

      const now = new Date();
      const nowLabel = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}`;
      let defaultIdx = allSheets.findIndex(s => s.name === nowLabel);
      if (defaultIdx < 0) defaultIdx = allSheets.length - 1;

      allSheets.forEach((sheet, i) => {
        const tab = document.createElement('div');
        const isThisActive = (activeGid ? sheet.gid == activeGid : i === defaultIdx);
        tab.className = 'tab' + (isThisActive ? ' active' : '');
        tab.textContent = sheet.name;
        tab.onclick = () => {
          selectedDay = null;
          switchTab(sheet.gid, tab);
        };
        container.appendChild(tab);
        if (isThisActive && !activeGid) {
          currentGid = sheet.gid;
          switchTab(sheet.gid, tab);
        }
      });
    }

    function switchTab(gid, tabEl) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tabEl.classList.add('active');
      tabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      currentGid = gid;

      const cachedData = localStorage.getItem(`roster_data_${gid}`);
      if (cachedData) {
        currentData = JSON.parse(cachedData);
        render(currentData);
        hideLoading();
        loadSheet(gid, true, true);
      } else {
        loadSheet(gid);
      }
    }

    function loadSheet(gid, force = false, silent = false) {
      if (!silent) showLoading();
      jsonp({ gid }, (result) => {
        const data = result.data || result;
        currentData = data;
        localStorage.setItem(`roster_data_${gid}`, JSON.stringify(data));
        render(data);
        hideLoading();
      }, (err) => {
        hideLoading();
        console.error(err);
      });
    }

    function refreshCurrent() {
      if (currentGid) loadSheet(currentGid, true);
    }

    function jsonp(params, onSuccess, onError) {
      const cbName = '__gs_' + Date.now() + Math.floor(Math.random() * 1000);
      window[cbName] = (data) => { delete window[cbName]; onSuccess(data); };
      const qs = Object.entries({ ...params, callback: cbName, t: Date.now() }).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join('&');
      const s = document.createElement('script');
      s.src = `${SCRIPT_URL}?${qs}`;
      s.onerror = () => onError('網路連線異常');
      document.head.appendChild(s);
      setTimeout(() => { if (window[cbName]) onError('連線逾時'); }, 15000);
    }

    function showLoading() { document.getElementById('loadingOverlay').style.opacity = '1'; document.getElementById('loadingOverlay').style.pointerEvents = 'all'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.opacity = '0'; document.getElementById('loadingOverlay').style.pointerEvents = 'none'; }

    function selectDate(day) {
      selectedDay = day;
      render(currentData);
    }

    function render(rows) {
      const { y, mo } = detectMonth(rows);
      const total = new Date(y, mo, 0).getDate();
      let sw = new Date(y, mo - 1, 1).getDay();
      sw = sw === 0 ? 6 : sw - 1;

      const dc = findDayCol(rows);
      if (!dc) return;
      const map = buildMap(rows, dc.c, total);

      document.getElementById('mLabel').textContent = `${y} / ${String(mo).padStart(2, '0')}`;

      const now = new Date();
      const isCurrentMonth = (now.getFullYear() === y && now.getMonth() + 1 === mo);
      const today = isCurrentMonth ? now.getDate() : -1;

      const targetDay = selectedDay || (today !== -1 ? today : 1);

      const cont = document.getElementById('content');
      let html = '';

      for (const g of Object.values(GROUPS)) {
        let cards = '';
        let workOnTarget = 0;

        for (const name of g.names) {
          const key = Object.keys(map).find(k => k === name || k.includes(name));
          const emp = key ? map[key] : null;
          let offDays = 0, ptHours = 0;

          if (emp) {
            for (let d = 1; d <= total; d++) {
              const s = emp.sh[d];
              if (s === '休' || s.includes('年')) offDays++;
              else if (PART_TIME.includes(name)) ptHours += calcPtHours(s);
              if (d === targetDay && isWorking(s)) workOnTarget++;
            }
          }

          const calHtml = generateCalendar(sw, total, today, targetDay, emp);

          let showHours = '';
          if (emp && emp.hr) {
            const hr = emp.hr.trim().replace(/^P/i, '').replace('-', ' – ');
            if (hr !== '11:00 – 20:00' && hr !== '11:00–20:00' && hr !== 'POS' && hr !== '外') {
              showHours = hr;
            }
          }

          const statLabel = PART_TIME.includes(name)
            ? `休 <b>${offDays}</b> 天 · <b style="color:#7db8e8">${ptHours}</b> 小時`
            : `休 <b>${offDays}</b> 天`;

          cards += `
        <div class="ecard">
          <div class="einfo">
            <div>
              <div class="ename">${name}</div>
              ${showHours ? `<div class="ehours">${showHours}</div>` : ''}
            </div>
            <div class="offc">${statLabel}</div>
          </div>
          <div class="cal">${calHtml}</div>
        </div>`;
        }

        // 格式化人數統計列：無論是否為今天，日期/今天文字都用白色，且與後方保持空格
        const labelText = (targetDay === today) ? '今天' : `${mo} / ${targetDay}`;
        const dateTitle = `<span style="color:#fff">${labelText}</span>&nbsp;`;

        html += `
      <div class="group">
        <div class="group-head">
          <span class="gbadge ${g.cls}">${g.label}</span>
          <span class="gname">${dateTitle} <b style="color:${targetDay === today ? 'var(--green)' : 'var(--accent)'}">${workOnTarget}</b> 人上班</span>
        </div>
        ${cards}
      </div>`;
      }

      cont.innerHTML = html;
      document.getElementById('updFooter').textContent = `最後同步: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function generateCalendar(sw, total, today, targetDay, emp) {
      let h = WD.map(w => `<div class="cwd">${w}</div>`).join('');

      // 空白格子使用 .empty 類別，移除底色
      for (let e = 0; e < sw; e++) h += `<div class="cd empty"></div>`;

      // 日期格子使用 .has-date 類別，保留底色
      for (let d = 1; d <= total; d++) {
        const isToday = d === today;
        const isSelected = d === targetDay;
        const shift = emp ? emp.sh[d] : '';
        h += `<div class="cd has-date ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" onclick="selectDate(${d})">
      <div class="dn">${d}</div>
      ${renderShift(shift)}
    </div>`;
      }
      return h;
    }

    function renderShift(v) {
      if (!v) return `<span class="dot">·</span>`;
      const trimmed = v.trim();

      if (trimmed === '休') return `<span class="sb" style="color:var(--red)">休</span>`;
      if (trimmed === '盤') return `<span class="sb" style="color:var(--accent)">盤</span>`;
      if (trimmed.includes('年')) return `<span class="sb" style="color:#e8854a">年</span>`;

      if (trimmed.includes('禁')) {
        return `<div class="sb"><span class="time-tag">9:30</span><span class="memo-tag">禁</span></div>`;
      }

      const timeMatch = trimmed.match(/(\d{1,2}[-:]\d{2})/);
      const hasTime = !!timeMatch;
      const timeStr = hasTime ? timeMatch[1] : '';
      const isNormalShift = timeStr === '11-20' || timeStr === '11:20';

      let textPart = trimmed.replace(/\d{1,2}[-:]\d{2}/g, '').trim();
      let parts = [];

      if (hasTime && !isNormalShift) {
        parts.push(`<span class="time-tag">${timeStr}</span>`);
      }

      if (textPart) {
        parts.push(`<span class="memo-tag">${textPart}</span>`);
      }

      if (isNormalShift && !textPart) {
        return `<span class="dot">·</span>`;
      }

      return parts.length > 0
        ? `<div class="sb">${parts.join('')}</div>`
        : `<span class="dot">·</span>`;
    }

    function calcPtHours(s) {
      const m = s.match(/(\d{1,2})[-:](\d{2})/);
      if (!m) return 0;
      let start = parseInt(m[1]);
      let end = parseInt(m[2]);
      let h = end - start;
      if (h < 0) h += 24;
      return h > 4 ? h - 1 : h;
    }

    function isWorking(s) {
      if (!s) return false;
      const ts = s.trim();
      return ts !== '' && ts !== '休' && !ts.includes('年');
    }

    function detectMonth(rows) {
      for (const cell of (rows[0] || [])) {
        const m = String(cell).match(/(\d{4})\/(\d{2})/);
        if (m) return { y: +m[1], mo: +m[2] };
      }
      return { y: new Date().getFullYear(), mo: new Date().getMonth() + 1 };
    }

    function findDayCol(rows) {
      for (let r = 0; r < Math.min(rows.length, 10); r++)
        for (let c = 0; c < rows[r].length - 3; c++)
          if (String(rows[r][c]).trim() === '1' && String(rows[r][c + 1]).trim() === '2') return { r, c };
      return null;
    }

    function buildMap(rows, fc, total) {
      const map = {};
      rows.forEach(row => {
        const nm = String(row[2] || '').trim();
        if (!nm || nm.length > 10 || /^\d+$/.test(nm)) return;
        const sh = {};
        for (let d = 1; d <= total; d++) sh[d] = String(row[fc + d - 1] || '').trim();
        map[nm] = { hr: String(row[3] || '').trim().replace(' - ', '–'), sh };
      });
      return map;
    }

    init();
  </script>
</body>

</html>